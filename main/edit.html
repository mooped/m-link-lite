<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>M-Link Lite Robot Controller</title>
    <link rel="stylesheet" href="style.css">
    <script type='application/javascript' src='m-link.js'></script>
    <script type='application/javascript' src='jquery.min.js'></script>
    <script type='application/javascript'>
      let mlink = undefined

      $(document).ready(function() {
        mlink = new MLink(`ws://${MLink.defaultHost}/ws`,
        {
          onmessage: function(obj) {
            // Update name from settings
            if (obj && obj.settings)
            {
              if (obj.settings.name)
              {
                $('#name').html(obj.settings.name)
                document.title = obj.settings.name
              }
              delete obj.settings
            }
          },
          onopen: function() {
            $('#result').val('Connected')
          },
          onclose: function(code, reason) {
            $('#result').val('Connection closed by server: ' + code + ' "' + reason + '"\n')
          }
        })
        mlink.begin()

        // Register listener for menu button
        $('#hamburger').click(function (evt) {
          window.location = '/'
        })
      })
    </script>
    <style>
      html, body {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 0;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div id="info">
      <h1 class="small" id="name">M-Link Lite Robot Controller</h1>
      <span class="small" id="result"></span>
      <div id="hamburger" class="menu"><img src="hamburger.svg" alt="Menu Button" /></div>
    </div> 
    <div id="panel" style="width: 50%; height: 50%"></div>
    <form id="mixer-panel">
      <b style="grid-area: header;" class="title">Mixer</b>
      <div style="grid-area: in1">In 1</div>
      <div style="grid-area: in2">In 2</div>
      <div style="grid-area: in3">In 3</div>
      <div style="grid-area: in4">In 4</div>
      <div style="grid-area: in5">In 5</div>
      <div style="grid-area: in6">In 6</div>
      <div style="grid-area: out1">Out 1</div>
      <div style="grid-area: out2">Out 2</div>
      <div style="grid-area: out3">Out 3</div>
      <div style="grid-area: out4">Out 4</div>
      <div style="grid-area: out5">Out 5</div>
      <div style="grid-area: out6">Out 6</div>
      <div style="grid-area: out6">Out 6</div>
      <div style="grid-area: x; text-align: center;">x</div>
      <div style="grid-area: y; margin: auto;">=</div>
      <input style="grid-area: c11;" type="number" id="c11" name="c11" value="1" step="0.01"/>
      <input style="grid-area: c21;" type="number" id="c21" name="c21" value="0" step="0.01"/>
      <input style="grid-area: c31;" type="number" id="c31" name="c31" value="0" step="0.01"/>
      <input style="grid-area: c41;" type="number" id="c41" name="c41" value="0" step="0.01"/>
      <input style="grid-area: c51;" type="number" id="c51" name="c51" value="0" step="0.01"/>
      <input style="grid-area: c61;" type="number" id="c61" name="c61" value="0" step="0.01"/>
      <input style="grid-area: c12;" type="number" id="c12" name="c12" value="0" step="0.01"/>
      <input style="grid-area: c22;" type="number" id="c22" name="c22" value="1" step="0.01"/>
      <input style="grid-area: c32;" type="number" id="c32" name="c32" value="0" step="0.01"/>
      <input style="grid-area: c42;" type="number" id="c42" name="c42" value="0" step="0.01"/>
      <input style="grid-area: c52;" type="number" id="c52" name="c52" value="0" step="0.01"/>
      <input style="grid-area: c62;" type="number" id="c62" name="c62" value="0" step="0.01"/>
      <input style="grid-area: c13;" type="number" id="c13" name="c13" value="0" step="0.01"/>
      <input style="grid-area: c23;" type="number" id="c23" name="c23" value="0" step="0.01"/>
      <input style="grid-area: c33;" type="number" id="c33" name="c33" value="1" step="0.01"/>
      <input style="grid-area: c43;" type="number" id="c43" name="c43" value="0" step="0.01"/>
      <input style="grid-area: c53;" type="number" id="c53" name="c53" value="0" step="0.01"/>
      <input style="grid-area: c63;" type="number" id="c63" name="c63" value="0" step="0.01"/>
      <input style="grid-area: c14;" type="number" id="c14" name="c14" value="0" step="0.01"/>
      <input style="grid-area: c24;" type="number" id="c24" name="c24" value="0" step="0.01"/>
      <input style="grid-area: c34;" type="number" id="c34" name="c34" value="0" step="0.01"/>
      <input style="grid-area: c44;" type="number" id="c44" name="c44" value="1" step="0.01"/>
      <input style="grid-area: c54;" type="number" id="c54" name="c54" value="0" step="0.01"/>
      <input style="grid-area: c64;" type="number" id="c64" name="c64" value="0" step="0.01"/>
      <input style="grid-area: c15;" type="number" id="c15" name="c15" value="0" step="0.01"/>
      <input style="grid-area: c25;" type="number" id="c25" name="c25" value="0" step="0.01"/>
      <input style="grid-area: c35;" type="number" id="c35" name="c35" value="0" step="0.01"/>
      <input style="grid-area: c45;" type="number" id="c45" name="c45" value="0" step="0.01"/>
      <input style="grid-area: c55;" type="number" id="c55" name="c55" value="1" step="0.01"/>
      <input style="grid-area: c65;" type="number" id="c65" name="c65" value="0" step="0.01"/>
      <input style="grid-area: c16;" type="number" id="c16" name="c16" value="0" step="0.01"/>
      <input style="grid-area: c26;" type="number" id="c26" name="c26" value="0" step="0.01"/>
      <input style="grid-area: c36;" type="number" id="c36" name="c36" value="0" step="0.01"/>
      <input style="grid-area: c46;" type="number" id="c46" name="c46" value="0" step="0.01"/>
      <input style="grid-area: c56;" type="number" id="c56" name="c56" value="0" step="0.01"/>
      <input style="grid-area: c66;" type="number" id="c66" name="c66" value="1" step="0.01"/>
    </form>
    <form id="layout-panel">
      <b style="grid-area: p1;" class="title">Panel 1</b>
      <label style="grid-area: x1l" for="x1">Col</label>
      <label style="grid-area: y1l" for="y1">Row</label>
      <label style="grid-area: w1l" for="w1">Width</label>
      <label style="grid-area: h1l" for="h1">Height</label>
      <label style="grid-area: t1l" for="t1">Type</label>
      <label style="grid-area: ca1l" for="ca1">X/B</label>
      <label style="grid-area: cb1l" for="cb1">Y</label>

      <input style="grid-area: x1" type="number" id="x1" name="x1" value="1" min="1" max="5"/>
      <input style="grid-area: w1" type="number" id="w1" name="w1" value="5" min="1" max="5"/>
      <input style="grid-area: y1" type="number" id="y1" name="y1" value="1" min="1" max="5"/>
      <input style="grid-area: h1" type="number" id="h1" name="h1" value="5" min="1" max="5"/>
      <input style="grid-area: ca1" type="number" id="ca1" name="ca1" value="1" min="1" max="6"/>
      <input style="grid-area: cb1" type="number" id="cb1" name="cb1" value="1" min="1" max="6"/>
      <select style="grid-area: t1" id="t1" name="t1">
        <option value="u">Unused</option>
        <option value="j" selected>Joystick</option>
        <option value="b">Button</option>
      </select>

      <b style="grid-area: p2;" class="title">Panel 2</b>
      <label style="grid-area: x2l" for="x2">Col</label>
      <label style="grid-area: y2l" for="y2">Row</label>
      <label style="grid-area: w2l" for="w2">Width</label>
      <label style="grid-area: h2l" for="h2">Height</label>
      <label style="grid-area: t2l" for="t2">Type</label>
      <label style="grid-area: ca2l" for="ca2">X/B</label>
      <label style="grid-area: cb2l" for="cb2">Y</label>

      <input style="grid-area: x2" type="number" id="x2" name="x2" value="1" min="1" max="5"/>
      <input style="grid-area: w2" type="number" id="w2" name="w2" value="1" min="1" max="5"/>
      <input style="grid-area: y2" type="number" id="y2" name="y2" value="1" min="1" max="5"/>
      <input style="grid-area: h2" type="number" id="h2" name="h2" value="1" min="1" max="5"/>
      <input style="grid-area: ca2" type="number" id="ca2" name="ca2" value="2" min="1" max="6"/>
      <input style="grid-area: cb2" type="number" id="cb2" name="cb2" value="2" min="1" max="6"/>
      <select style="grid-area: t2" id="t2" name="t2">
        <option value="u" selected>Unused</option>
        <option value="j">Joystick</option>
        <option value="b">Button</option>
      </select>

      <b style="grid-area: p3;" class="title">Panel 3</b>
      <label style="grid-area: x3l" for="x3">Col</label>
      <label style="grid-area: y3l" for="y3">Row</label>
      <label style="grid-area: w3l" for="w3">Width</label>
      <label style="grid-area: h3l" for="h3">Height</label>
      <label style="grid-area: t3l" for="t3">Type</label>
      <label style="grid-area: ca3l" for="ca3">X/B</label>
      <label style="grid-area: cb3l" for="cb3">Y</label>

      <input style="grid-area: x3" type="number" id="x3" name="x3" value="1" min="1" max="5"/>
      <input style="grid-area: w3" type="number" id="w3" name="w3" value="1" min="1" max="5"/>
      <input style="grid-area: y3" type="number" id="y3" name="y3" value="1" min="1" max="5"/>
      <input style="grid-area: h3" type="number" id="h3" name="h3" value="1" min="1" max="5"/>
      <input style="grid-area: ca3" type="number" id="ca3" name="ca3" value="3" min="1" max="6"/>
      <input style="grid-area: cb3" type="number" id="cb3" name="cb3" value="3" min="1" max="6"/>
      <select style="grid-area: t3" id="t3" name="t3">
        <option value="u" selected>Unused</option>
        <option value="j">Joystick</option>
        <option value="b">Button</option>
      </select>

      <b style="grid-area: p4;" class="title">Panel 4</b>
      <label style="grid-area: x4l" for="x4">Col</label>
      <label style="grid-area: y4l" for="y4">Row</label>
      <label style="grid-area: w4l" for="w4">Width</label>
      <label style="grid-area: h4l" for="h4">Height</label>
      <label style="grid-area: t4l" for="t4">Type</label>
      <label style="grid-area: ca4l" for="ca4">X/B</label>
      <label style="grid-area: cb4l" for="cb4">Y</label>

      <input style="grid-area: x4" type="number" id="x4" name="x4" value="1" min="1" max="5"/>
      <input style="grid-area: w4" type="number" id="w4" name="w4" value="1" min="1" max="5"/>
      <input style="grid-area: y4" type="number" id="y4" name="y4" value="1" min="1" max="5"/>
      <input style="grid-area: h4" type="number" id="h4" name="h4" value="1" min="1" max="5"/>
      <input style="grid-area: ca4" type="number" id="ca4" name="ca4" value="4" min="1" max="6"/>
      <input style="grid-area: cb4" type="number" id="cb4" name="cb4" value="4" min="1" max="6"/>
      <select style="grid-area: t4" id="t4" name="t4">
        <option value="u" selected>Unused</option>
        <option value="j">Joystick</option>
        <option value="b">Button</option>
      </select>

      <b style="grid-area: p5;" class="title">Panel 5</b>
      <label style="grid-area: x5l" for="x5">Col</label>
      <label style="grid-area: y5l" for="y5">Row</label>
      <label style="grid-area: w5l" for="w5">Width</label>
      <label style="grid-area: h5l" for="h5">Height</label>
      <label style="grid-area: t5l" for="t5">Type</label>
      <label style="grid-area: ca5l" for="ca5">X/B</label>
      <label style="grid-area: cb5l" for="cb5">Y</label>
      
      <input style="grid-area: x5" type="number" id="x5" name="x5" value="1" min="1" max="5"/>
      <input style="grid-area: w5" type="number" id="w5" name="w5" value="1" min="1" max="5"/>
      <input style="grid-area: y5" type="number" id="y5" name="y5" value="1" min="1" max="5"/>
      <input style="grid-area: h5" type="number" id="h5" name="h5" value="1" min="1" max="5"/>
      <input style="grid-area: ca5" type="number" id="ca5" name="ca5" value="5" min="1" max="6"/>
      <input style="grid-area: cb5" type="number" id="cb5" name="cb5" value="5" min="1" max="6"/>
      <select style="grid-area: t5" id="t5" name="t5">
        <option value="u" selected>Unused</option>
        <option value="j">Joystick</option>
        <option value="b">Button</option>
      </select>

      <b style="grid-area: p6;" class="title">Panel 6</b>
      <label style="grid-area: x6l" for="x6">Col</label>
      <label style="grid-area: y6l" for="y6">Row</label>
      <label style="grid-area: w6l" for="w6">Width</label>
      <label style="grid-area: h6l" for="h6">Height</label>
      <label style="grid-area: t6l" for="t6">Type</label>
      <label style="grid-area: ca6l" for="ca6">X/B</label>
      <label style="grid-area: cb6l" for="cb6">Y</label>

      <input style="grid-area: x6" type="number" id="x6" name="x6" value="1" min="1" max="5"/>
      <input style="grid-area: w6" type="number" id="w6" name="w6" value="1" min="1" max="5"/>
      <input style="grid-area: y6" type="number" id="y6" name="y6" value="1" min="1" max="5"/>
      <input style="grid-area: h6" type="number" id="h6" name="h6" value="1" min="1" max="5"/>
      <input style="grid-area: ca6" type="number" id="ca6" name="ca6" value="6" min="1" max="6"/>
      <input style="grid-area: cb6" type="number" id="cb6" name="cb6" value="6" min="1" max="6"/>
      <select style="grid-area: t6" id="t6" name="t6">
        <option value="u" selected>Unused</option>
        <option value="j">Joystick</option>
        <option value="b">Button</option>
      </select>
    </form>
    <script src="nipplejs.js"></script>
    <script src="grid.js"></script>
    <script>
      const apps = []
      const panel = document.getElementById('panel')
      const typeClasses = {
        j: Joystick,
        b: Button,
      }
      const createApp = function (type, options = {}) {
        const cell = document.createElement('div')
        if (typeClasses[type]) {
          const app = new typeClasses[type](cell, options)
          apps.push(app)
          panel.appendChild(cell)
          app.create()
        }
      }

      let rebuildMixer = function (evt) {
        mixerData = $('#mixer-panel').serialize()
        console.log('Mixer changed')
      }

      let rebuildLayout = function (evt) {
        console.log('Grid layout changed')
        for (const app of apps) {
          app.destroy()
          delete app
        }
        console.log("Destroyed apps", apps)
        layoutData = $('#layout-panel').serialize()
        let params = Object.fromEntries(layoutData.split('&').map(x => x.split('=')))
        console.log("New app args:", params)
        let argN = function (arg, index, def) {
          return params[arg + index.toString()] || def
        }
        for (var i = 0; i < 6; ++i) {
          createApp(argN('t', i + 1, 'u'), {
            x: argN('x', i + 1, 1),
            y: argN('y', i + 1, 1),
            width: argN('w', i + 1, 1),
            height: argN('h', i + 1, 1),
            ca: argN('ca', i + 1, -1),
            cb: argN('cb', i + 1, -1),
          })
        }
      }

      // Register listener for mixer changes
      $('#mixer-panel').children().on('change', function (evt) {
        rebuildMixer()
      })

      // Register listener for layout changes
      $('#layout-panel').children().on('change', function (evt) {
        rebuildLayout()
      })

      $(document).ready(function() {
        rebuildLayout()
      })
      /*
      var joystickL = nipplejs.create({
        zone: document.getElementById('left'),
        mode: 'static',
        position: { left: '50%', top: '50%' },
        color: '#105905',
        size: 200,
      })
      var joystickL = nipplejs.create({
        zone: document.getElementById('right'),
        mode: 'static',
        position: { left: '50%', top: '50%' },
        color: '#105905',
        size: 200,
      })
      setInterval(async function(){
        var status = 'waiting'
        if (mlink) {
          const x = Math.round(joystick.deltaX() * 5)
          const y = Math.round(joystick.deltaY() * 5)
          await mlink.setServos([
            parseInt(1500 - y),
            parseInt(1500 + x),
            1500,
            1500,
            1500,
            1500
          ])

          status = mlink.status
        }
        var outputEl = document.getElementById('result')
        outputEl.innerHTML = status
      }, 1/30 * 1000)
      */
    </script>
  </body>
</html>
