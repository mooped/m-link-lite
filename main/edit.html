<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>M-Link Lite Robot Controller</title>
    <link rel="stylesheet" href="style.css">
    <script type='application/javascript' src='m-link.js'></script>
    <script type='application/javascript' src='jquery.min.js'></script>
    <script type='application/javascript'>
      let mlink = undefined

      $(document).ready(function() {
        mlink = new MLink(`ws://${MLink.defaultHost}/ws`,
        {
          onmessage: function(obj) {
            // Update name from settings
            if (obj && obj.settings)
            {
              if (obj.settings.name)
              {
                $('#name').html(obj.settings.name)
                document.title = obj.settings.name
              }
              delete obj.settings
            }
          },
          onopen: function() {
            $('#result').val('Connected')
          },
          onclose: function(code, reason) {
            $('#result').val('Connection closed by server: ' + code + ' "' + reason + '"\n')
          }
        })
        mlink.begin()

        // Register listener for menu button
        $('#hamburger').click(function (evt) {
          window.location = '/'
        })
      })
    </script>
    <style>
      html, body {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 0;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div id="panel" style="width: 50%; height: 50%"></div>
    <div id="mixer-panel">
      <table>
        <tr>
          <th colspan="9">Mixer</th>
        </tr>
        <tr>
          <td colspan="2"></td>
          <th>[</th>
          <th>In 1</th>
          <th>In 2</th>
          <th>In 3</th>
          <th>In 4</th>
          <th>In 5</th>
          <th>In 6</th>
          <th>]</th>
          <th></th>
        </tr>
        <tr>
          <th rowspan="7">[</th>
          <td></td>
          <th rowspan="7">] = [</th>
          <th colspan="6">x</td>
          <th rowspan="7">]</th>
          <td></td>
        </tr>
        <tr>
          <th>Out 1</th>
          <td><input type="number" class="mixer" id="mix11" value="1"/></td>
          <td><input type="number" class="mixer" id="mix12" value="0"/></td>
          <td><input type="number" class="mixer" id="mix13" value="0"/></td>
          <td><input type="number" class="mixer" id="mix14" value="0"/></td>
          <td><input type="number" class="mixer" id="mix15" value="0"/></td>
          <td><input type="number" class="mixer" id="mix16" value="0"/></td>
        </tr>
        <tr>
          <th>Out 2</th>
          <td><input type="number" class="mixer" id="mix21" value="0"/></td>
          <td><input type="number" class="mixer" id="mix22" value="1"/></td>
          <td><input type="number" class="mixer" id="mix23" value="0"/></td>
          <td><input type="number" class="mixer" id="mix24" value="0"/></td>
          <td><input type="number" class="mixer" id="mix25" value="0"/></td>
          <td><input type="number" class="mixer" id="mix26" value="0"/></td>
        </tr>
        <tr>
          <th>Out 3</th>
          <td><input type="number" class="mixer" id="mix31" value="0"/></td>
          <td><input type="number" class="mixer" id="mix32" value="0"/></td>
          <td><input type="number" class="mixer" id="mix33" value="1"/></td>
          <td><input type="number" class="mixer" id="mix34" value="0"/></td>
          <td><input type="number" class="mixer" id="mix35" value="0"/></td>
          <td><input type="number" class="mixer" id="mix36" value="0"/></td>
        </tr>
        <tr>
          <th>Out 4</th>
          <td><input type="number" class="mixer" id="mix41" value="0"/></td>
          <td><input type="number" class="mixer" id="mix42" value="0"/></td>
          <td><input type="number" class="mixer" id="mix43" value="0"/></td>
          <td><input type="number" class="mixer" id="mix44" value="1"/></td>
          <td><input type="number" class="mixer" id="mix45" value="0"/></td>
          <td><input type="number" class="mixer" id="mix46" value="0"/></td>
        </tr>
        <tr>
          <th>Out 5</th>
          <td><input type="number" class="mixer" id="mix51" value="0"/></td>
          <td><input type="number" class="mixer" id="mix52" value="0"/></td>
          <td><input type="number" class="mixer" id="mix53" value="0"/></td>
          <td><input type="number" class="mixer" id="mix54" value="0"/></td>
          <td><input type="number" class="mixer" id="mix55" value="1"/></td>
          <td><input type="number" class="mixer" id="mix56" value="0"/></td>
        </tr>
        <tr>
          <th>Out 6</th>
          <td><input type="number" class="mixer" id="mix61" value="0"/></td>
          <td><input type="number" class="mixer" id="mix62" value="0"/></td>
          <td><input type="number" class="mixer" id="mix63" value="0"/></td>
          <td><input type="number" class="mixer" id="mix64" value="0"/></td>
          <td><input type="number" class="mixer" id="mix65" value="0"/></td>
          <td><input type="number" class="mixer" id="mix66" value="1"/></td>
        </tr>
      </table>
    </div>
    <div id="editor-panel">
      <table>
        <tr>
          <th colspan="6">Panel 1</th>
        </tr>
        <tr>
          <td><label class="small" for="panelX1">X</label></td>
          <td><input type="number" id="panelX1" class="panel-x small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelW1">W</label></td>
          <td><input type="number" id="panelW1" class="panel-w small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelXCh1">X Ch</label></td>
          <td><input type="number" id="panelXCh1" class="panel-xch small small-panel" data-control="1" value="1" min="1" max="6"/></td>
        </tr>
        <tr>
          <td><label class="small" for="panelY1">Y</label></td>
          <td><input type="number" id="panelY1" class="panel-y small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelH1">H</label></td>
          <td><input type="number" id="panelH1" class="panel-h small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelYCh1">Y Ch</label></td>
          <td><input type="number" id="panelYCh1" class="panel-ych small small-panel" data-control="1" value="1" min="1" max="6"/></td>
        </tr>
        <tr>
          <td><input type="radio" id="unused1" name="type1" value="unused" checked/></td>
          <td><label for="unused1">Unused</label></td>
          <td><input type="radio" id="joystick1" name="type1" value="joystick"/></td>
          <td><label for="joystick1">Joystick</label></td>
          <td><input type="radio" id="button1" name="type1" value="button"/></td>
          <td><label for="button1">Button</label></td>
        </tr>
        <tr>
          <th colspan="6">Panel 2</th>
        </tr>
        <tr>
          <td><label class="small" for="panelX2">X</label></td>
          <td><input type="number" id="panelX2" class="panel-x small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelW2">W</label></td>
          <td><input type="number" id="panelW2" class="panel-w small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelXCh2">X Ch</label></td>
          <td><input type="number" id="panelXCh2" class="panel-xch small small-panel" data-control="1" value="1" min="1" max="6"/></td>
        </tr>
        <tr>
          <td><label class="small" for="panelY2">Y</label></td>
          <td><input type="number" id="panelY2" class="panel-y small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelH2">H</label></td>
          <td><input type="number" id="panelH2" class="panel-h small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelYCh2">Y Ch</label></td>
          <td><input type="number" id="panelYCh2" class="panel-ych small small-panel" data-control="1" value="1" min="1" max="6"/></td>
        </tr>
        <tr>
          <td><input type="radio" id="unused2" name="type2" value="unused" checked/></td>
          <td><label for="unused2">Unused</label></td>
          <td><input type="radio" id="joystick2" name="type2" value="joystick"/></td>
          <td><label for="joystick2">Joystick</label></td>
          <td><input type="radio" id="button2" name="type2" value="button"/></td>
          <td><label for="button2">Button</label></td>
        </tr>
        <tr>
          <th colspan="6">Panel 3</th>
        </tr>
        <tr>
          <td><label class="small" for="panelX3">X</label></td>
          <td><input type="number" id="panelX3" class="panel-x small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelW3">W</label></td>
          <td><input type="number" id="panelW3" class="panel-w small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelXCh3">X Ch</label></td>
          <td><input type="number" id="panelXCh3" class="panel-xch small small-panel" data-control="1" value="1" min="1" max="6"/></td>
        </tr>
        <tr>
          <td><label class="small" for="panelY3">Y</label></td>
          <td><input type="number" id="panelY3" class="panel-y small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelH3">H</label></td>
          <td><input type="number" id="panelH3" class="panel-h small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelYCh3">Y Ch</label></td>
          <td><input type="number" id="panelYCh3" class="panel-ych small small-panel" data-control="1" value="1" min="1" max="6"/></td>
        </tr>
        <tr>
          <td><input type="radio" id="unused3" name="type3" value="unused" checked/></td>
          <td><label for="unused3">Unused</label></td>
          <td><input type="radio" id="joystick3" name="type3" value="joystick"/></td>
          <td><label for="joystick3">Joystick</label></td>
          <td><input type="radio" id="button3" name="type3" value="button"/></td>
          <td><label for="button3">Button</label></td>
        </tr>
        <tr>
          <th colspan="6">Panel 4</th>
        </tr>
        <tr>
          <td><label class="small" for="panelX4">X</label></td>
          <td><input type="number" id="panelX4" class="panel-x small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelW4">W</label></td>
          <td><input type="number" id="panelW4" class="panel-w small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelXCh4">X Ch</label></td>
          <td><input type="number" id="panelXCh4" class="panel-xch small small-panel" data-control="1" value="1" min="1" max="6"/></td>
        </tr>
        <tr>
          <td><label class="small" for="panelY4">Y</label></td>
          <td><input type="number" id="panelY4" class="panel-y small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelH4">H</label></td>
          <td><input type="number" id="panelH4" class="panel-h small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelYCh4">Y Ch</label></td>
          <td><input type="number" id="panelYCh4" class="panel-ych small small-panel" data-control="1" value="1" min="1" max="6"/></td>
        </tr>
        <tr>
          <td><input type="radio" id="unused4" name="type4" value="unused" checked/></td>
          <td><label for="unused4">Unused</label></td>
          <td><input type="radio" id="joystick4" name="type4" value="joystick"/></td>
          <td><label for="joystick4">Joystick</label></td>
          <td><input type="radio" id="button4" name="type4" value="button"/></td>
          <td><label for="button4">Button</label></td>
        </tr>
        <tr>
          <th colspan="6">Panel 5</th>
        </tr>
        <tr>
          <td><label class="small" for="panelX5">X</label></td>
          <td><input type="number" id="panelX5" class="panel-x small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelW5">W</label></td>
          <td><input type="number" id="panelW5" class="panel-w small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelXCh5">X Ch</label></td>
          <td><input type="number" id="panelXCh5" class="panel-xch small small-panel" data-control="1" value="1" min="1" max="6"/></td>
        </tr>
        <tr>
          <td><label class="small" for="panelY5">Y</label></td>
          <td><input type="number" id="panelY5" class="panel-y small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelH5">H</label></td>
          <td><input type="number" id="panelH5" class="panel-h small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelYCh5">Y Ch</label></td>
          <td><input type="number" id="panelYCh5" class="panel-ych small small-panel" data-control="1" value="1" min="1" max="6"/></td>
        </tr>
        <tr>
          <td><input type="radio" id="unused5" name="type5" value="unused" checked/></td>
          <td><label for="unused5">Unused</label></td>
          <td><input type="radio" id="joystick5" name="type5" value="joystick"/></td>
          <td><label for="joystick5">Joystick</label></td>
          <td><input type="radio" id="button5" name="type5" value="button"/></td>
          <td><label for="button5">Button</label></td>
        </tr>
        <tr>
          <th colspan="6">Panel 6</th>
        </tr>
        <tr>
          <td><label class="small" for="panelX6">X</label></td>
          <td><input type="number" id="panelX6" class="panel-x small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelW6">W</label></td>
          <td><input type="number" id="panelW6" class="panel-w small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelXCh6">X Ch</label></td>
          <td><input type="number" id="panelXCh6" class="panel-xch small small-panel" data-control="1" value="1" min="1" max="6"/></td>
        </tr>
        <tr>
          <td><label class="small" for="panelY6">Y</label></td>
          <td><input type="number" id="panelY6" class="panel-y small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelH6">H</label></td>
          <td><input type="number" id="panelH6" class="panel-h small small-panel" data-control="1" value="1" min="1" max="5"/></td>
          <td><label class="small" for="panelYCh6">Y Ch</label></td>
          <td><input type="number" id="panelYCh6" class="panel-ych small small-panel" data-control="1" value="1" min="1" max="6"/></td>
        </tr>
        <tr>
          <td><input type="radio" id="unused6" name="type6" value="unused" checked/></td>
          <td><label for="unused6">Unused</label></td>
          <td><input type="radio" id="joystick6" name="type6" value="joystick"/></td>
          <td><label for="joystick6">Joystick</label></td>
          <td><input type="radio" id="button6" name="type6" value="button"/></td>
          <td><label for="button6">Button</label></td>
        </tr>
      </table>
    </div>
    <div id="info">
      <h1 class="small" id="name">M-Link Lite Robot Controller</h1>
      <span class="small" id="result"></span>
      <div id="hamburger" class="menu"><img src="hamburger.svg" alt="Menu Button" /></div>
    </div> 
    <script src="nipplejs.js"></script>
    <script src="grid.js"></script>
    <script>
      const apps = []
      const panel = document.getElementById('panel')
      /*
      for (var i = 0; i < panel.children.length; ++i) {
        const cell = panel.children[i]
        const app = new Joystick(cell, {})
        apps.push(app)
        app._render()
      }*/
      const typeClasses = {
        joystick: Joystick,
        button: Button,
      }
      const createApp = function (type, options = {}) {
        const cell = document.createElement('div')
        const app = new typeClasses[type](cell, options)
        apps.push(app)
        panel.appendChild(cell)
        app._render()
      }
      /*
      var layout = {
        panels: [
          {
            type: 'stick',
            x: 1,
            y: 1,
            w: 5,
            h: 5,
            size: 200,
            color: '#105905',
            background: 'rgba(0, 255, 0, 0.1)',
          },
          {
            type: 'stick',
            x: 6,
            y: 1,
            w: 5,
            h: 10,
            size: 200,
            color: '#105905',
            background: 'rgba(0, 0, 255, 0.1)',
          }
        ]
      }
      let template = function (definition) {
        const element = document.createElement('div')
        console.log(definition)
        element.style.background = definition.background
        element.style.gridColumn = definition.x.toString() + ' / span ' + definition.w.toString()
        element.style.gridRow = definition.y.toString() + ' / span ' + definition.h.toString()
        element.style.width = '100%'
        element.style.height = '100%'
        element.style.position = 'relative'
        return {
          element,
          callback: function () {
            nipplejs.create({
              zone: element,
              mode: 'static',
              position: { left: '50%', top: '50%' },
              color: definition.color,
              size: definition.size,
            })
          }
        }
      }
      let panel = document.getElementById('panel')
      for (let panelDefinition of layout.panels) {
        const result = template(panelDefinition)
        if (result.element) {
          panel.appendChild(result.element)
          if (result.callback) {
            result.callback()
          }
        }
      }
      /*
      /*
      var joystickL = nipplejs.create({
        zone: document.getElementById('left'),
        mode: 'static',
        position: { left: '50%', top: '50%' },
        color: '#105905',
        size: 200,
      })
      var joystickL = nipplejs.create({
        zone: document.getElementById('right'),
        mode: 'static',
        position: { left: '50%', top: '50%' },
        color: '#105905',
        size: 200,
      })
      setInterval(async function(){
        var status = 'waiting'
        if (mlink) {
          const x = Math.round(joystick.deltaX() * 5)
          const y = Math.round(joystick.deltaY() * 5)
          await mlink.setServos([
            parseInt(1500 - y),
            parseInt(1500 + x),
            1500,
            1500,
            1500,
            1500
          ])

          status = mlink.status
        }
        var outputEl = document.getElementById('result')
        outputEl.innerHTML = status
      }, 1/30 * 1000)
      */
    </script>
  </body>
</html>
