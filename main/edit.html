<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>M-Link Lite Robot Controller</title>
    <link rel="stylesheet" href="style.css">
    <script type='application/javascript' src='m-link.js'></script>
    <script type='application/javascript' src='jquery.min.js'></script>
    <script type='application/javascript'>
      let mlink = undefined

      $(document).ready(function() {
        mlink = new MLink(`ws://${MLink.defaultHost}/ws`,
        {
          onmessage: function(obj) {
            // Update name from settings
            if (obj && obj.settings)
            {
              if (obj.settings.name)
              {
                $('#name').html(obj.settings.name)
                document.title = obj.settings.name
              }
              delete obj.settings
            }
          },
          onopen: function() {
            $('#result').val('Connected')
          },
          onclose: function(code, reason) {
            $('#result').val('Connection closed by server: ' + code + ' "' + reason + '"\n')
          }
        })
        mlink.begin()

        // Register listener for menu button
        $('#hamburger').click(function (evt) {
          window.location = '/'
        })
      })
    </script>
    <style>
      html, body {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 0;
        margin: 0;
      }
      #panel {
        width: 50%;
        height: 50%;
      }
      @media (max-width: 1250px) {
        body {
          overflow-y: scroll;
        }
        #panel {
          width: 100%;
          height: 100%;
        }
        #mixer-panel {
          width: 98%;
          height: 100%;
          top: 200%;
          left: 1%;
        }
        #layout-panel {
          width: 90%;
          height: 100%;
          top: 100%;
          left: 5%;
        }
      }
    </style>
  </head>
  <body>
    <div id="panel"></div>
    <form id="mixer-panel">
      <b style="grid-area: header;" class="title">Mixer</b>
      <div style="grid-area: in1">In 1</div>
      <div style="grid-area: in2">In 2</div>
      <div style="grid-area: in3">In 3</div>
      <div style="grid-area: in4">In 4</div>
      <div style="grid-area: in5">In 5</div>
      <div style="grid-area: in6">In 6</div>
      <div style="grid-area: out1">Out 1</div>
      <div style="grid-area: out2">Out 2</div>
      <div style="grid-area: out3">Out 3</div>
      <div style="grid-area: out4">Out 4</div>
      <div style="grid-area: out5">Out 5</div>
      <div style="grid-area: out6">Out 6</div>
      <div style="grid-area: out6">Out 6</div>
      <div style="grid-area: x; text-align: center;">x</div>
      <div style="grid-area: y; margin: auto;">=</div>
      <input style="grid-area: c11;" type="number" id="c11" name="c11" value="1" step="0.01"/>
      <input style="grid-area: c21;" type="number" id="c21" name="c21" value="0" step="0.01"/>
      <input style="grid-area: c31;" type="number" id="c31" name="c31" value="0" step="0.01"/>
      <input style="grid-area: c41;" type="number" id="c41" name="c41" value="0" step="0.01"/>
      <input style="grid-area: c51;" type="number" id="c51" name="c51" value="0" step="0.01"/>
      <input style="grid-area: c61;" type="number" id="c61" name="c61" value="0" step="0.01"/>
      <input style="grid-area: c12;" type="number" id="c12" name="c12" value="0" step="0.01"/>
      <input style="grid-area: c22;" type="number" id="c22" name="c22" value="1" step="0.01"/>
      <input style="grid-area: c32;" type="number" id="c32" name="c32" value="0" step="0.01"/>
      <input style="grid-area: c42;" type="number" id="c42" name="c42" value="0" step="0.01"/>
      <input style="grid-area: c52;" type="number" id="c52" name="c52" value="0" step="0.01"/>
      <input style="grid-area: c62;" type="number" id="c62" name="c62" value="0" step="0.01"/>
      <input style="grid-area: c13;" type="number" id="c13" name="c13" value="0" step="0.01"/>
      <input style="grid-area: c23;" type="number" id="c23" name="c23" value="0" step="0.01"/>
      <input style="grid-area: c33;" type="number" id="c33" name="c33" value="1" step="0.01"/>
      <input style="grid-area: c43;" type="number" id="c43" name="c43" value="0" step="0.01"/>
      <input style="grid-area: c53;" type="number" id="c53" name="c53" value="0" step="0.01"/>
      <input style="grid-area: c63;" type="number" id="c63" name="c63" value="0" step="0.01"/>
      <input style="grid-area: c14;" type="number" id="c14" name="c14" value="0" step="0.01"/>
      <input style="grid-area: c24;" type="number" id="c24" name="c24" value="0" step="0.01"/>
      <input style="grid-area: c34;" type="number" id="c34" name="c34" value="0" step="0.01"/>
      <input style="grid-area: c44;" type="number" id="c44" name="c44" value="1" step="0.01"/>
      <input style="grid-area: c54;" type="number" id="c54" name="c54" value="0" step="0.01"/>
      <input style="grid-area: c64;" type="number" id="c64" name="c64" value="0" step="0.01"/>
      <input style="grid-area: c15;" type="number" id="c15" name="c15" value="0" step="0.01"/>
      <input style="grid-area: c25;" type="number" id="c25" name="c25" value="0" step="0.01"/>
      <input style="grid-area: c35;" type="number" id="c35" name="c35" value="0" step="0.01"/>
      <input style="grid-area: c45;" type="number" id="c45" name="c45" value="0" step="0.01"/>
      <input style="grid-area: c55;" type="number" id="c55" name="c55" value="1" step="0.01"/>
      <input style="grid-area: c65;" type="number" id="c65" name="c65" value="0" step="0.01"/>
      <input style="grid-area: c16;" type="number" id="c16" name="c16" value="0" step="0.01"/>
      <input style="grid-area: c26;" type="number" id="c26" name="c26" value="0" step="0.01"/>
      <input style="grid-area: c36;" type="number" id="c36" name="c36" value="0" step="0.01"/>
      <input style="grid-area: c46;" type="number" id="c46" name="c46" value="0" step="0.01"/>
      <input style="grid-area: c56;" type="number" id="c56" name="c56" value="0" step="0.01"/>
      <input style="grid-area: c66;" type="number" id="c66" name="c66" value="1" step="0.01"/>
    </form>
    <form id="layout-panel">
      <b style="grid-area: p1;" class="title">Panel 1</b>
      <label style="grid-area: w1l" for="w1">Width</label>
      <label style="grid-area: h1l" for="h1">Height</label>
      <label style="grid-area: t1l" for="t1">Type</label>
      <label style="grid-area: ca1l" for="ca1">X/B</label>
      <label style="grid-area: cb1l" for="cb1">Y</label>
      <label style="grid-area: f1l" for="f1">Fg</label>
      <label style="grid-area: b1l" for="b1">Bg</label>
      <label style="grid-area: l1l" for="l1">Label</label>
      <label style="grid-area: va1l" for="va1">Idle</label>
      <label style="grid-area: vb1l" for="vb1">Active</label>

      <input style="grid-area: w1" type="number" id="w1" name="w1" value="5" min="1" max="5"/>
      <input style="grid-area: h1" type="number" id="h1" name="h1" value="5" min="1" max="5"/>
      <select style="grid-area: t1" id="t1" name="t1">
        <option value="u">Unused</option>
        <option value="j" selected>Joystick</option>
        <option value="b">Button</option>
        <option value="p">Padding</option>
      </select>
      <input style="grid-area: ca1" type="number" id="ca1" name="ca1" value="1" min="0" max="6"/>
      <input style="grid-area: cb1" type="number" id="cb1" name="cb1" value="2" min="0" max="6"/>
      <input style="grid-area: f1" type="color" id="f1" name="f1" value="#195905"/>
      <input style="grid-area: b1" type="color" id="b1" name="b1" value="#f0feec"/>
      <input style="grid-area: l1" type="text" id="l1" name="l1" value=""/>
      <input style="grid-area: va1" type="number" id="va1" name="va1" value="-1" step="0.01"/>
      <input style="grid-area: vb1" type="number" id="vb1" name="vb1" value="1" step="0.01"/>

      <b style="grid-area: p2;" class="title">Panel 2</b>
      <label style="grid-area: w2l" for="w2">Width</label>
      <label style="grid-area: h2l" for="h2">Height</label>
      <label style="grid-area: t2l" for="t2">Type</label>
      <label style="grid-area: ca2l" for="ca2">Ch 1</label>
      <label style="grid-area: cb2l" for="cb2">Ch 2</label>
      <label style="grid-area: f2l" for="f2">Fg</label>
      <label style="grid-area: b2l" for="b2">Bg</label>
      <label style="grid-area: l2l" for="l1">Label</label>
      <label style="grid-area: va2l" for="va2">Idle</label>
      <label style="grid-area: vb2l" for="vb2">Active</label>

      <input style="grid-area: w2" type="number" id="w2" name="w2" value="1" min="1" max="5"/>
      <input style="grid-area: h2" type="number" id="h2" name="h2" value="1" min="1" max="5"/>
      <select style="grid-area: t2" id="t2" name="t2">
        <option value="u" selected>Unused</option>
        <option value="j">Joystick</option>
        <option value="b">Button</option>
        <option value="p">Padding</option>
      </select>
      <input style="grid-area: ca2" type="number" id="ca2" name="ca2" value="3" min="0" max="6"/>
      <input style="grid-area: cb2" type="number" id="cb2" name="cb2" value="4" min="0" max="6"/>
      <input style="grid-area: f2" type="color" id="f2" name="f2" value="#8e5572"/>
      <input style="grid-area: b2" type="color" id="b2" name="b2" value="#e8d9e1"/>
      <input style="grid-area: l2" type="text" id="l2" name="l2" value=""/>
      <input style="grid-area: va2" type="number" id="va2" name="va2" value="-1" step="0.01"/>
      <input style="grid-area: vb2" type="number" id="vb2" name="vb2" value="1" step="0.01"/>

      <b style="grid-area: p3;" class="title">Panel 3</b>
      <label style="grid-area: w3l" for="w3">Width</label>
      <label style="grid-area: h3l" for="h3">Height</label>
      <label style="grid-area: t3l" for="t3">Type</label>
      <label style="grid-area: ca3l" for="ca3">X/B</label>
      <label style="grid-area: cb3l" for="cb3">Y</label>
      <label style="grid-area: f3l" for="f3">Fg</label>
      <label style="grid-area: b3l" for="b3">Bg</label>
      <label style="grid-area: l3" for="l3">Label</label>
      <label style="grid-area: va3l" for="va3">Idle</label>
      <label style="grid-area: vb3l" for="vb3">Active</label>

      <input style="grid-area: w3" type="number" id="w3" name="w3" value="1" min="1" max="5"/>
      <input style="grid-area: h3" type="number" id="h3" name="h3" value="1" min="1" max="5"/>
      <select style="grid-area: t3" id="t3" name="t3">
        <option value="u" selected>Unused</option>
        <option value="j">Joystick</option>
        <option value="b">Button</option>
        <option value="p">Padding</option>
      </select>
      <input style="grid-area: ca3" type="number" id="ca3" name="ca3" value="5" min="0" max="6"/>
      <input style="grid-area: cb3" type="number" id="cb3" name="cb3" value="6" min="0" max="6"/>
      <input style="grid-area: f3" type="color" id="f3" name="f3" value="#6eb257"/>
      <input style="grid-area: b3" type="color" id="b3" name="b3" value="#dbecd5"/>
      <input style="grid-area: l3" type="text" id="l3" name="l3" value=""/>
      <input style="grid-area: va3" type="number" id="va3" name="va3" value="-1" step="0.01"/>
      <input style="grid-area: vb3" type="number" id="vb3" name="vb3" value="1" step="0.01"/>

      <b style="grid-area: p4;" class="title">Panel 4</b>
      <label style="grid-area: w4l" for="w4">Width</label>
      <label style="grid-area: h4l" for="h4">Height</label>
      <label style="grid-area: t4l" for="t4">Type</label>
      <label style="grid-area: ca4l" for="ca4">X/B</label>
      <label style="grid-area: cb4l" for="cb4">Y</label>
      <label style="grid-area: f4l" for="f4">Fg</label>
      <label style="grid-area: b4l" for="b4">Bg</label>
      <label style="grid-area: l4l" for="l4">Label</label>
      <label style="grid-area: va4l" for="va4">Idle</label>
      <label style="grid-area: vb4l" for="vb4">Active</label>

      <input style="grid-area: w4" type="number" id="w4" name="w4" value="1" min="1" max="5"/>
      <input style="grid-area: h4" type="number" id="h4" name="h4" value="1" min="1" max="5"/>
      <select style="grid-area: t4" id="t4" name="t4">
        <option value="u" selected>Unused</option>
        <option value="j">Joystick</option>
        <option value="b">Button</option>
        <option value="p">Padding</option>
      </select>
      <input style="grid-area: ca4" type="number" id="ca4" name="ca4" value="0" min="0" max="6"/>
      <input style="grid-area: cb4" type="number" id="cb4" name="cb4" value="0" min="0" max="6"/>
      <input style="grid-area: f4" type="color" id="f4" name="f4" value="#f18f01"/>
      <input style="grid-area: b4" type="color" id="b4" name="b4" value="#ffe6c2"/>
      <input style="grid-area: l4" type="text" id="l4" name="l4" value=""/>
      <input style="grid-area: va4" type="number" id="va4" name="va4" value="-1" step="0.01"/>
      <input style="grid-area: vb4" type="number" id="vb4" name="vb4" value="1" step="0.01"/>

      <b style="grid-area: p5;" class="title">Panel 5</b>
      <label style="grid-area: w5l" for="w5">Width</label>
      <label style="grid-area: h5l" for="h5">Height</label>
      <label style="grid-area: t5l" for="t5">Type</label>
      <label style="grid-area: ca5l" for="ca5">X/B</label>
      <label style="grid-area: cb5l" for="cb5">Y</label>
      <label style="grid-area: f5l" for="f5">Fg</label>
      <label style="grid-area: b5l" for="b5">Bg</label>
      <label style="grid-area: l5l" for="l5">Label</label>
      <label style="grid-area: va5l" for="va5">Idle</label>
      <label style="grid-area: vb5l" for="vb5">Active</label>
      
      <input style="grid-area: w5" type="number" id="w5" name="w5" value="1" min="1" max="5"/>
      <input style="grid-area: h5" type="number" id="h5" name="h5" value="1" min="1" max="5"/>
      <select style="grid-area: t5" id="t5" name="t5">
        <option value="u" selected>Unused</option>
        <option value="j">Joystick</option>
        <option value="b">Button</option>
        <option value="p">Padding</option>
      </select>
      <input style="grid-area: ca5" type="number" id="ca5" name="ca5" value="0" min="0" max="6"/>
      <input style="grid-area: cb5" type="number" id="cb5" name="cb5" value="0" min="0" max="6"/>
      <input style="grid-area: f5" type="color" id="f5" name="f5" value="#d0f0c0"/>
      <input style="grid-area: b5" type="color" id="b5" name="b5" value="#285313"/>
      <input style="grid-area: l5" type="text" id="l5" name="l5" value=""/>
      <input style="grid-area: va5" type="number" id="va5" name="va5" value="-1" step="0.01"/>
      <input style="grid-area: vb5" type="number" id="vb5" name="vb5" value="1" step="0.01"/>

      <b style="grid-area: p6;" class="title">Panel 6</b>
      <label style="grid-area: w6l" for="w6">Width</label>
      <label style="grid-area: h6l" for="h6">Height</label>
      <label style="grid-area: t6l" for="t6">Type</label>
      <label style="grid-area: ca6l" for="ca6">X/B</label>
      <label style="grid-area: cb6l" for="cb6">Y</label>
      <label style="grid-area: f6l" for="f6">Fg</label>
      <label style="grid-area: b6l" for="b6">Bg</label>
      <label style="grid-area: l6l" for="l6">Label</label>
      <label style="grid-area: va6l" for="va6">Idle</label>
      <label style="grid-area: vb6l" for="vb6">Active</label>

      <input style="grid-area: w6" type="number" id="w6" name="w6" value="1" min="1" max="5"/>
      <input style="grid-area: h6" type="number" id="h6" name="h6" value="1" min="1" max="5"/>
      <select style="grid-area: t6" id="t6" name="t6">
        <option value="u" selected>Unused</option>
        <option value="j">Joystick</option>
        <option value="b">Button</option>
        <option value="p">Padding</option>
      </select>
      <input style="grid-area: ca6" type="number" id="ca6" name="ca6" value="0" min="0" max="6"/>
      <input style="grid-area: cb6" type="number" id="cb6" name="cb6" value="0" min="0" max="6"/>
      <input style="grid-area: f6" type="color" id="f6" name="f6" value="#508991"/>
      <input style="grid-area: b6" type="color" id="b6" name="b6" value="#cadfe2"/>
      <input style="grid-area: l6" type="text" id="l6" name="l6" value=""/>
      <input style="grid-area: va6" type="number" id="va6" name="va6" value="-1" step="0.01"/>
      <input style="grid-area: vb6" type="number" id="vb6" name="vb6" value="1" step="0.01"/>
    </form>
    <div id="info">
      <h1 class="small" id="name">M-Link Lite Robot Controller</h1>
      <span class="small" id="result"></span>
      <div id="hamburger" class="menu"><img src="hamburger.svg" alt="Menu Button" /></div>
    </div> 
    <script src="nipplejs.js"></script>
    <script src="grid.js"></script>
    <script>
      const apps = []
      const panel = document.getElementById('panel')
      const typeClasses = {
        j: Joystick,
        b: Button,
        p: Padding,
      }
      const createApp = function (type, options = {}) {
        const cell = document.createElement('div')
        if (typeClasses[type]) {
          const app = new typeClasses[type](cell, options)
          apps.push(app)
          panel.appendChild(cell)
          app.create()
        }
      }

      let rebuildMixer = function (evt) {
        mixerData = $('#mixer-panel').serialize()
        console.log('Mixer changed')
      }

      let rebuildLayout = function (evt) {
        console.log('Grid layout changed')
        while (apps.length > 0) {
          apps.pop().destroy()
        }
        layoutData = $('#layout-panel').serialize()
        let params = Object.fromEntries(layoutData.split('&').map(x => x.split('=')))
        let argN = function (arg, index, def) {
          return decodeURIComponent(params[arg + index.toString()]) || def
        }
        for (var i = 1; i < 7; ++i) {
          createApp(argN('t', i, 'u'), {
            width: argN('w', i, 1),
            height: argN('h', i, 1),
            ca: argN('ca', i, -1),
            cb: argN('cb', i, -1),
            va: argN('va', i, 500),
            vb: argN('vb', i, 1500),
            foreground: argN('f', i, '#bbbbbb'),
            background: argN('b', i, '#105905'),
            label: argN('l', i, ''),
          })
        }
      }

      // Register listener for mixer changes
      $('#mixer-panel').children().on('change', function (evt) {
        rebuildMixer()
      })

      // Register listener for layout changes
      $('#layout-panel').children().on('change', function (evt) {
        rebuildLayout()
      })

      $(document).ready(function() {
        rebuildLayout()
      })
      /*
      var joystickL = nipplejs.create({
        zone: document.getElementById('left'),
        mode: 'static',
        position: { left: '50%', top: '50%' },
        color: '#105905',
        size: 200,
      })
      var joystickL = nipplejs.create({
        zone: document.getElementById('right'),
        mode: 'static',
        position: { left: '50%', top: '50%' },
        color: '#105905',
        size: 200,
      })
      setInterval(async function(){
        var status = 'waiting'
        if (mlink) {
          const x = Math.round(joystick.deltaX() * 5)
          const y = Math.round(joystick.deltaY() * 5)
          await mlink.setServos([
            parseInt(1500 - y),
            parseInt(1500 + x),
            1500,
            1500,
            1500,
            1500
          ])

          status = mlink.status
        }
        var outputEl = document.getElementById('result')
        outputEl.innerHTML = status
      }, 1/30 * 1000)
      */
    </script>
  </body>
</html>
