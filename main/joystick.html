<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>M-Link Lite Robot Controller</title>
    <link rel="stylesheet" href="style.css">
    <script type='application/javascript' src='m-link.js'></script>
    <script type='application/javascript' src='jquery.min.js'></script>
    <script type='application/javascript'>
      let mlink = undefined

      $(document).ready(function() {
        mlink = new MLink(`ws://${MLink.defaultHost}/ws`,
        {
          onmessage: function(obj) {
            // Update name from settings
            if (obj && obj.settings) {
              if (obj.settings.name) {
                $('#name').html(obj.settings.name)
                document.title = obj.settings.name
              }
              delete obj.settings
            }
          },
          onopen: function() {
            $('#result').val('Connected')
          },
          onclose: function(code, reason) {
            $('#result').val('Connection closed by server: ' + code + ' "' + reason + '"\n')
          }
        })
        mlink.begin()

        // Register listener for menu button
        $('#hamburger').click(function (evt) {
          window.location = '/'
        })

        // Load the current preset
        $.get('/layout.json', function (data, status) {
          if (status === 'success') {
            presets['saved'] = JSON.parse(data)
            loadPreset('saved')
          }
        })
      })
    </script>
    <style>
      html, body {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 0;
        margin: 0;
      }
      #panel {
        width: 100% !important;
        height: 100% !important;
      }
    </style>
  </head>
  <body>
    <div id="panel"></div>
    <div id="info">
      <h1 class="small" id="name">M-Link Lite Robot Controller</h1>
      <span class="small" id="result"></span>
      <div id="hamburger" class="menu"><img src="hamburger.svg" alt="Menu Button" /></div>
    </div> 
    <script src="nipplejs.js"></script>
    <script src="grid.js"></script>
    <script type='application/javascript' src='hexapod.js'></script>
    <script type='application/javascript' src='vector.js'></script>
    <script>
      const apps = []
      const typeClasses = {
        j: Joystick,
        b: Button,
        p: Padding,
      }
      const createApp = function (type, options = {}) {
        const cell = document.createElement('div')
        if (typeClasses[type]) {
          const app = new typeClasses[type](cell, options)
          apps.push(app)
          panel.appendChild(cell)
          app.create()
          return app
        }
      }

      let stanceApp = undefined
      let translationApp = undefined
      let rotationApp = undefined
      let legApps = [undefined, undefined, undefined, undefined, undefined, undefined]
      let resetApp = undefined
      let stopApp = undefined

      let rebuildLayout = function (evt) {
        while (apps.length > 0) {
          apps.pop().destroy()
        }
        rotationApp = createApp('j', {
          width: 1,
          height: 2,
          ca: 0,
          cb: 1,
          idle: 0,
          pressed: 1,
          foreground: '#edffad',
          background: '#506600',
          pressed: 0,
          label: 'Rotation'
        })
        translationApp = createApp('j', {
          width: 3,
          height: 3,
          ca: 0,
          cb: 1,
          idle: 0,
          pressed: 1,
          foreground: '#48acf0',
          background: '#083c5e',
          label: 'Translation'
        })
        stanceApp = createApp('j', {
          width: 1,
          height: 2,
          ca: 0,
          cb: 1,
          idle: 0,
          pressed: 1,
          foreground: '#c8ffbe',
          background: '#0f6600',
          label: 'Stance'
        })
        legApps[0] = createApp('j', {
          width: 1,
          height: 1,
          ca: 0,
          cb: 1,
          idle: 0,
          pressed: 1,
          foreground: '#990D35',
          background: '#5e0820',
          label: 'Leg1'
        })
        legApps[5] = createApp('j', {
          width: 1,
          height: 1,
          ca: 0,
          cb: 1,
          idle: 0,
          pressed: 1,
          foreground: '#990D35',
          background: '#5e0820',
          label: 'Leg6'
        })
        legApps[1] = createApp('j', {
          width: 1,
          height: 1,
          ca: 0,
          cb: 1,
          idle: 0,
          pressed: 1,
          foreground: '#990D35',
          background: '#5e0820',
          label: 'Leg2'
        })
        resetApp = createApp('b', {
          width: 1,
          height: 2,
          ca: 0,
          cb: 1,
          idle: 0,
          pressed: 1,
          foreground: '#3772ff',
          background: '#001f66',
          label: 'Reset'
        })
        stopApp = createApp('b', {
          width: 2,
          height: 2,
          ca: 0,
          cb: 1,
          idle: 0,
          pressed: 1,
          foreground: '#3772ff',
          background: '#001f66',
          label: 'Stop'
        })
        legApps[4] = createApp('j', {
          width: 1,
          height: 1,
          ca: 0,
          cb: 1,
          idle: 0,
          pressed: 1,
          foreground: '#990D35',
          background: '#5e0820',
          label: 'Leg5'
        })
        legApps[2] = createApp('j', {
          width: 1,
          height: 1,
          ca: 0,
          cb: 1,
          idle: 0,
          pressed: 1,
          foreground: '#990D35',
          background: '#5e0820',
          label: 'Leg2'
        })
        legApps[3] = createApp('j', {
          width: 1,
          height: 1,
          ca: 0,
          cb: 1,
          idle: 0,
          pressed: 1,
          foreground: '#990D35',
          background: '#5e0820',
          label: 'Leg4'
        })
      }

      $(document).ready(function() {
        rebuildLayout()

        let hexapod = new Hexapod()

        let servoIndex = 0;
        setInterval(async function() {
          var status = 'waiting'

          if (mlink) {
            // Update inputs
            let stanceData = stanceApp?.channels || { 0: 0, 1: 0 }
            hexapod.setStance(stanceData[0], stanceData[1])

            let translationData = translationApp?.channels || { 0: 0, 1: 0 }
            hexapod.setTranslation(translationData[0], translationData[1])

            let rotationData = rotationApp?.channels || { 0: 0, 1: 0 }
            hexapod.setRotation(rotationData[0], rotationData[1])

            for (let leg = 0; leg < 6; ++leg) {
              let legData = legApps[leg]?.channels || { 0: 0, 1: 0 }
              hexapod.setLeg(leg, legData[0], legData[1])
            }

            let resetData = resetApp?.channels || { 0: 0 }
            if (resetData[0]) {
              hexapod.resetServos()
            }

            let stopData = stopApp?.channels || { 0: 0 }
            if (stopData[0]) {
              hexapod.stopServos()
            }

            // Tick the hexapod 'mixer'
            hexapod.tick()

            // Send outputs to the servos
            await mlink.setServos(hexapod.outputs)

            // Store status
            status = mlink.status
          }

          var outputEl = document.getElementById('result')
          outputEl.innerHTML = status
        }, 1/60 * 1000)
      })
    </script>
  </body>
</html>
